# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a **Payload CMS v3** ecommerce template built with **Next.js 15 App Router** for **Perth Dry Cleaning Supplies** - a local business selling professional dry cleaning equipment, supplies, and chemicals to businesses and consumers.

### Business Context

**Domain**: Dry cleaning supplies and equipment
**Target Audience**:
- Professional dry cleaners and laundromats
- Small business owners
- Individual consumers needing professional-grade cleaning supplies

**Product Categories** (typical):
- Dry cleaning chemicals and solvents
- Garment bags and hangers
- Pressing equipment
- Spotting supplies
- Laundry detergents and additives
- Garment tags and tickets
- Safety equipment

**Design Considerations**:
- Professional, trustworthy aesthetic - these are commercial/industrial products
- Clear product specifications and safety information must be prominent
- B2B and B2C hybrid - support both bulk ordering and individual purchases
- Local business focus - emphasize Perth location and local service
- Compliance-focused - proper handling of hazardous materials information

## Development Commands

### Local Development
```bash
pnpm dev              # Start development server at http://localhost:3000
pnpm build            # Production build
pnpm start            # Run production server
```

### Code Quality
```bash
pnpm lint             # Run ESLint
pnpm lint:fix         # Fix ESLint issues
```

### Testing
```bash
pnpm test             # Run both integration and E2E tests
pnpm test:int         # Run Vitest integration tests
pnpm test:e2e         # Run Playwright E2E tests
```

### Payload-Specific
```bash
pnpm payload generate:types     # Generate TypeScript types from Payload config
pnpm payload generate:importmap # Generate import map
pnpm payload migrate:create     # Create new database migration (Postgres)
pnpm payload migrate            # Run pending migrations
```

### Stripe Development
```bash
pnpm stripe-webhooks   # Listen for Stripe webhooks locally (requires Stripe CLI)
```

## Architecture

### Tech Stack
- **Framework**: Next.js 15 with App Router (React 19)
- **CMS**: Payload CMS v3
- **Database**: Vercel Postgres (PostgreSQL adapter)
- **Payments**: Stripe via Payload ecommerce plugin
- **Styling**: TailwindCSS 4 + shadcn/ui components
- **Forms**: React Hook Form
- **Rich Text**: Lexical editor
- **Testing**: Vitest (integration) + Playwright (E2E)

### Directory Structure

#### `/src/collections/`
Payload collections define the data models:
- **Users**: Auth-enabled, supports `admin` and `customer` roles
- **Pages**: Layout builder enabled, draft/publish workflow
- **Products**: Managed by ecommerce plugin, supports variants (important for different sizes, concentrations, packaging)
- **Categories**: Product taxonomy (e.g., "Chemicals", "Equipment", "Garment Supplies")
- **Media**: Upload collection for images/assets (product images, safety data sheets, manuals)
- **Carts**, **Orders**, **Transactions**, **Addresses**: Auto-generated by ecommerce plugin

#### `/src/globals/`
Global singleton data (Header, Footer) accessible throughout the site.

#### `/src/blocks/`
Reusable content blocks for the layout builder:
- `ArchiveBlock`, `Banner`, `CallToAction`, `Carousel`, `Code`, `Content`, `Form`, `MediaBlock`, `ThreeItemGrid`
- Each block has a config file (defining Payload schema) and a `Component.tsx` (Next.js frontend)

#### `/src/heros/`
Hero section variants: `HighImpact`, `MediumImpact`, `LowImpact`

#### `/src/app/(app)/`
Next.js frontend routes:
- `[slug]` - Dynamic pages
- `checkout/` - Checkout flow
- `shop/` - Product catalog
- `(account)/` - User account pages (orders, addresses)
- `products/` - Product detail pages

#### `/src/app/(payload)/`
Payload admin panel is served from this route group.

#### `/src/access/`
Access control functions for collections and fields:
- `adminOnly`, `adminOrPublishedStatus`, `adminOrCustomerOwner`, `adminOrSelf`
- `adminOnlyFieldAccess`, `customerOnlyFieldAccess`

#### `/src/plugins/`
Configures Payload plugins: SEO plugin, form builder, ecommerce plugin with Stripe adapter.

#### `/src/utilities/`
Shared utilities like `cn`, `mergeOpenGraph`, `generateMeta`, URL helpers, etc.

#### `/src/providers/`
React context providers: Auth, Theme, HeaderTheme.

#### `/src/components/`
- `ui/` - shadcn/ui components (button, dialog, input, etc.)
- `forms/` - Form components (LoginForm, CheckoutForm, etc.)
- `product/`, `checkout/`, `addresses/` - Feature-specific components
- Shared components: Header, Footer, Cart, AdminBar, etc.

### Database

This template uses **Postgres** via Vercel Postgres adapter. Key implications:

1. **Schema migrations required**: Unlike MongoDB, Postgres requires running migrations for schema changes.
2. **Local development**: `push: true` is enabled in dev, allowing schema changes without migrations. In production, set `push: false`.
3. **Migration workflow**:
   - Make schema changes in Payload config
   - Run `pnpm payload migrate:create` to generate migration files
   - Commit migration files
   - Run `pnpm payload migrate` on server before starting production

### Ecommerce Flow

1. **Products**: Defined via ecommerce plugin, support variants and pricing per currency.
   - For dry cleaning supplies: variants often represent different sizes, concentrations, or packaging options
   - Ensure product descriptions include technical specifications, usage instructions, and safety information
2. **Carts**: Track user and guest carts. Guests access by cart ID.
3. **Transactions**: Created when payment initiated, tracks payment status.
4. **Orders**: Created only when transaction completes successfully.
5. **Payments**: Stripe adapter configured, requires `STRIPE_SECRET_KEY`, `NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY`, `STRIPE_WEBHOOKS_SIGNING_SECRET`.

### Access Control

- **Admin users** (`role: 'admin'`): Full access to admin panel and all content.
- **Customer users** (`role: 'customer'`): Frontend access only, can view own orders/addresses.
  - For Perth Dry Cleaning Supplies: may want to support business accounts with purchase history, invoicing
- **Guests**: Can access published content, checkout, and retrieve orders by ID + email.
- Published content is public; drafts only accessible to admins.

### Draft Preview & Revalidation

- Pages and products support draft previews via Payload's versioning system.
- On-demand revalidation: When content is published, Next.js pages are revalidated via `afterChange` hooks.
- Live preview is supported in the admin panel for real-time editing feedback.

## Environment Variables

Copy `.env.example` to `.env` and configure:

```bash
PAYLOAD_SECRET=              # Required for Payload
POSTGRES_URL=                # Postgres connection string (Vercel Postgres)
NEXT_PUBLIC_SERVER_URL=      # Public URL (http://localhost:3000 in dev)
PAYLOAD_PUBLIC_SERVER_URL=   # Same as above
PREVIEW_SECRET=              # For draft preview

# Stripe
STRIPE_SECRET_KEY=
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=
STRIPE_WEBHOOKS_SIGNING_SECRET=
```

## Key Patterns

### Adding New Blocks
1. Create config in `/src/blocks/YourBlock/config.ts` defining Payload fields
2. Create frontend component in `/src/blocks/YourBlock/Component.tsx`
3. Register in layout builder field (typically in Pages collection)

### Adding New Collections
1. Define collection in `/src/collections/YourCollection/index.ts`
2. Add to `collections` array in `payload.config.ts`
3. Run `pnpm payload generate:types` to update TypeScript types
4. Create migration: `pnpm payload migrate:create`

### Access Control
Use access control functions from `/src/access/` in collection configs:
- `access: { read: adminOrPublishedStatus, create: adminOnly, ... }`
- Field-level access: `admin: { access: adminOnlyFieldAccess }`

### Styling
- Uses TailwindCSS 4 with PostCSS
- shadcn/ui components in `/src/components/ui/`
- Use `cn()` utility to merge className values
- Supports dark mode via `next-themes`
- **Design Direction**: Professional, clean, trustworthy - avoid overly consumer-focused or playful aesthetics

## Business-Specific Considerations

### Product Information
When working with product data, ensure:
- Clear technical specifications (concentration, volume, application method)
- Safety information and hazard warnings where applicable
- Usage instructions and dilution ratios
- Compatibility information (what materials/fabrics it works with)
- Storage and handling requirements

### Categories & Navigation
Product categorization should support both:
- **By product type**: Chemicals, Equipment, Supplies, Safety Gear
- **By use case**: Stain removal, Pressing, Packaging, Maintenance

### Customer Experience
- B2B customers may need: bulk pricing, account management, purchase history, invoicing
- B2C customers need: clear instructions, safety information, smaller quantity options
- Local delivery/pickup options should be prominent

### Content Strategy
- Educational content about proper use of dry cleaning chemicals
- Safety and compliance information
- How-to guides and best practices
- Product comparison guides

## Testing

- **Integration tests** (`tests/*.test.ts`): Test Payload collections, access control, hooks
- **E2E tests** (`tests/*.spec.ts`): Test full user flows with Playwright
- Test environment uses `test.env` for configuration

## Seeding Data

From admin panel, use "seed database" link to populate demo data. This is **destructive** - it drops existing data.

Demo customer credentials after seeding:
- Email: `customer@example.com`
- Password: `password`

## Important Notes

- **Postgres migrations**: Always create and run migrations before deploying schema changes.
- **Stripe webhooks**: In local dev, run `pnpm stripe-webhooks` to forward Stripe events.
- **Type generation**: After modifying Payload config, run `pnpm payload generate:types` to update `/src/payload-types.ts`.
- **Caching**: Next.js caching is disabled by default (configured for Payload Cloud with Cloudflare). If self-hosting, re-enable by removing `export const dynamic = 'force-dynamic'` and `no-store` fetch directives.
- **Domain Context**: Always keep in mind this is a professional dry cleaning supplies business - design and content decisions should reflect the professional, safety-conscious nature of the industry.
